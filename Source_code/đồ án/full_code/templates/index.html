<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Ph√¢n t√≠ch K·∫πt xe T·ª± ƒë·ªông</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        .folder-result { 
            border: 1px solid #ccc; 
            padding: 15px; 
            margin-bottom: 10px; 
            background-color: #f9f9f9;
        }
        .congested { color: red; font-weight: bold; }
        .normal { color: green; font-weight: bold; }
        .error-message { 
            color: white; 
            background-color: #dc3545; 
            padding: 10px; 
            border-radius: 5px; 
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üö¶ Ph√¢n t√≠ch K·∫πt xe t·ª´ ·∫¢nh (Gi√°m s√°t T·ª± ƒë·ªông)</h1>
    <p>H·ªá th·ªëng ƒëang gi√°m s√°t th∆∞ m·ª•c "monitored_folders". K·∫øt qu·∫£ s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t d∆∞·ªõi ƒë√¢y sau khi b·∫°n t·∫°o th∆∞ m·ª•c con m·ªõi v√† th√™m ·∫£nh.</p>

    <div id="results-container">ƒêang ch·ªù d·ªØ li·ªáu...</div>

    <script>
        function fetchResults() {
            fetch('/results')
                .then(response => {
                    // **B∆Ø·ªöC S·ª¨A L·ªñI 1: KI·ªÇM TRA L·ªñI HTTP**
                    if (!response.ok) {
                        // N·∫øu status kh√¥ng ph·∫£i 200 (v√≠ d·ª•: 500 Internal Server Error)
                        throw new Error(`L·ªói HTTP: ${response.status} ${response.statusText}. Vui l√≤ng ki·ªÉm tra console Python.`);
                    }
                    return response.json();
                })
                .then(data => {
                    const container = document.getElementById('results-container');
                    container.innerHTML = '';
                    
                    if (Object.keys(data).length === 0) {
                        container.innerHTML = 'Ch∆∞a c√≥ th∆∞ m·ª•c n√†o ƒë∆∞·ª£c x·ª≠ l√Ω.';
                        return;
                    }

                    // Duy·ªát qua t·ª´ng th∆∞ m·ª•c ƒë√£ x·ª≠ l√Ω
                    for (const folderName in data) {
                        const folderDiv = document.createElement('div');
                        folderDiv.className = 'folder-result';
                        
                        let html = `<h2>üìÅ Th∆∞ m·ª•c: ${folderName}</h2>`;
                        html += '<ul>';

                        // Duy·ªát qua t·ª´ng file trong th∆∞ m·ª•c
                        data[folderName].forEach(fileResult => {
                            const statusClass = fileResult.status === 'K·∫πt xe' ? 'congested' : 'normal';
                            // **B∆Ø·ªöC S·ª¨A L·ªñI 2: TRUY C·∫¨P T·ªîNG S·ªê XE AN TO√ÄN H∆†N**
                            // ƒê·∫£m b·∫£o Total_Vehicles t·ªìn t·∫°i, n·∫øu kh√¥ng c√≥ th√¨ hi·ªÉn th·ªã N/A
                            const totalVehicles = fileResult.counts && fileResult.counts.Total_Vehicles !== undefined 
                                                ? fileResult.counts.Total_Vehicles 
                                                : 'N/A';
                                                
                            html += `<li>`;
                            // C·∫≠p nh·∫≠t hi·ªÉn th·ªã T·ªïng xe
                            html += `<strong>${fileResult.filename}</strong>: <span class="${statusClass}">${fileResult.status}</span> (P: ${fileResult.probability}, T·ªïng xe: ${totalVehicles})`;
                            html += `</li>`;
                        });

                        html += '</ul>';
                        folderDiv.innerHTML = html;
                        container.appendChild(folderDiv);
                    }
                })
                .catch(error => {
                    console.error('L·ªói khi fetch k·∫øt qu·∫£:', error);
                    // **B∆Ø·ªöC S·ª¨A L·ªñI 3: HI·ªÇN TH·ªä L·ªñI R√ï R√ÄNG TR√äN GIAO DI·ªÜN**
                    document.getElementById('results-container').innerHTML = 
                        `<div class="error-message">L·ªñI K·∫æT N·ªêI/API! Vui l√≤ng ki·ªÉm tra console Python. Chi ti·∫øt: ${error.message}</div>`;
                });
        }

        // G·ªçi h√†m fetchResults m·ªói 5 gi√¢y (Polling)
        fetchResults();
        setInterval(fetchResults, 5000); 
    </script>
</body>
</html>